# Rspack 构建器模块 API 文档

## rspack - 构建器和高级 API

`rspack` crate 提供了用户友好的构建器 API，是使用 Rspack 的主要入口点。

### 核心构建器

#### CompilerBuilder

```rust
/// 编译器构建器 - 主要的构建入口
pub struct CompilerBuilder {
    // 内部字段...
}

impl CompilerBuilder {
    /// 创建新的构建器
    pub fn new() -> Self;
    
    /// 设置配置名称
    pub fn name(mut self, name: impl Into<String>) -> Self;
    
    /// 设置目标环境
    pub fn target(mut self, target: impl Into<Targets>) -> Self;
    
    /// 添加入口点
    pub fn entry(mut self, name: impl Into<String>, entry: impl Into<String>) -> Self;
    
    /// 批量设置入口点
    pub fn entries(mut self, entries: impl IntoIterator<Item = (String, String)>) -> Self;
    
    /// 设置编译上下文目录
    pub fn context(mut self, context: impl AsRef<Utf8Path>) -> Self;
    
    /// 设置编译模式
    pub fn mode(mut self, mode: Mode) -> Self;
    
    /// 配置外部依赖
    pub fn externals(mut self, externals: Vec<ExternalItem>) -> Self;
    
    /// 配置外部依赖预设
    pub fn externals_presets(mut self, presets: ExternalsPresets) -> Self;
    
    /// 设置输出配置
    pub fn output(mut self, output: OutputOptions) -> Self;
    
    /// 设置模块配置
    pub fn module(mut self, module: ModuleOptions) -> Self;
    
    /// 设置解析配置
    pub fn resolve(mut self, resolve: Resolve) -> Self;
    
    /// 设置优化配置
    pub fn optimization(mut self, optimization: Optimization) -> Self;
    
    /// 设置实验性功能
    pub fn experiments(mut self, experiments: Experiments) -> Self;
    
    /// 设置开发服务器配置
    pub fn dev_server(mut self, dev_server: DevServer) -> Self;
    
    /// 设置监视配置
    pub fn watch(mut self, watch: WatchOptions) -> Self;
    
    /// 设置缓存配置
    pub fn cache(mut self, cache: CacheOptions) -> Self;
    
    /// 设置开发工具（source map）
    pub fn devtool(mut self, devtool: Devtool) -> Self;
    
    /// 添加插件
    pub fn plugin(mut self, plugin: BoxPlugin) -> Self;
    
    /// 批量添加插件
    pub fn plugins(mut self, plugins: Vec<BoxPlugin>) -> Self;
    
    /// 构建最终的编译器实例
    pub fn build(self) -> Result<Compiler, rspack_error::Error>;
}
```

### 配置选项构建器

#### OutputOptionsBuilder

```rust
/// 输出选项构建器
pub struct OutputOptionsBuilder {
    // 内部字段...
}

impl OutputOptionsBuilder {
    /// 创建默认构建器
    pub fn default() -> Self;
    
    /// 设置输出路径
    pub fn path(mut self, path: PathBuf) -> Self;
    
    /// 设置输出文件名模板
    pub fn filename(mut self, filename: Filename) -> Self;
    
    /// 设置 chunk 文件名模板  
    pub fn chunk_filename(mut self, chunk_filename: Filename) -> Self;
    
    /// 设置资源文件名模板
    pub fn asset_filename(mut self, asset_filename: Filename) -> Self;
    
    /// 设置公共路径
    pub fn public_path(mut self, public_path: PublicPath) -> Self;
    
    /// 设置库配置
    pub fn library(mut self, library: LibraryOptions) -> Self;
    
    /// 设置库目标
    pub fn library_target(mut self, target: LibraryType) -> Self;
    
    /// 设置是否清理输出目录
    pub fn clean(mut self, clean: bool) -> Self;
    
    /// 设置跨域配置
    pub fn cross_origin_loading(mut self, cross_origin: CrossOriginLoading) -> Self;
    
    /// 设置全局对象名
    pub fn global_object(mut self, global_object: String) -> Self;
    
    /// 设置哈希摘要长度
    pub fn hash_digest_length(mut self, length: usize) -> Self;
    
    /// 构建输出选项
    pub fn build(self) -> OutputOptions;
}
```

#### ModuleOptionsBuilder

```rust
/// 模块选项构建器
pub struct ModuleOptionsBuilder {
    // 内部字段...
}

impl ModuleOptionsBuilder {
    /// 创建默认构建器
    pub fn default() -> Self;
    
    /// 添加规则
    pub fn rule(mut self, rule: ModuleRule) -> Self;
    
    /// 批量添加规则
    pub fn rules(mut self, rules: Vec<ModuleRule>) -> Self;
    
    /// 设置默认规则
    pub fn default_rules(mut self, rules: Vec<ModuleRule>) -> Self;
    
    /// 设置解析器选项
    pub fn parser(mut self, parser: ParserOptions) -> Self;
    
    /// 设置生成器选项
    pub fn generator(mut self, generator: GeneratorOptions) -> Self;
    
    /// 构建模块选项
    pub fn build(self) -> ModuleOptions;
}
```

#### OptimizationOptionsBuilder

```rust
/// 优化选项构建器
pub struct OptimizationOptionsBuilder {
    // 内部字段...
}

impl OptimizationOptionsBuilder {
    /// 创建默认构建器
    pub fn default() -> Self;
    
    /// 设置是否启用压缩
    pub fn minimize(mut self, minimize: bool) -> Self;
    
    /// 添加压缩器
    pub fn minimizer(mut self, minimizer: BoxPlugin) -> Self;
    
    /// 设置代码分割配置
    pub fn split_chunks(mut self, split_chunks: SplitChunksOptions) -> Self;
    
    /// 设置运行时 chunk 配置
    pub fn runtime_chunk(mut self, runtime_chunk: RuntimeChunk) -> Self;
    
    /// 设置是否移除空 chunks
    pub fn remove_empty_chunks(mut self, remove: bool) -> Self;
    
    /// 设置是否合并重复 chunks
    pub fn merge_duplicate_chunks(mut self, merge: bool) -> Self;
    
    /// 设置是否启用副作用标记
    pub fn side_effects(mut self, side_effects: SideEffects) -> Self;
    
    /// 设置是否启用 tree shaking
    pub fn used_exports(mut self, used_exports: UsedExports) -> Self;
    
    /// 设置是否启用模块连接
    pub fn concatenate_modules(mut self, concatenate: bool) -> Self;
    
    /// 构建优化选项
    pub fn build(self) -> Optimization;
}
```

### 目标环境配置

#### Targets

```rust
/// 目标环境类型
pub type Targets = Vec<String>;

/// 常用目标环境预设
impl Targets {
    /// Web 环境
    pub fn web() -> Self {
        vec!["web".to_string()]
    }
    
    /// Node.js 环境
    pub fn node() -> Self {
        vec!["node".to_string()]
    }
    
    /// Electron 主进程
    pub fn electron_main() -> Self {
        vec!["electron-main".to_string()]
    }
    
    /// Electron 渲染进程
    pub fn electron_renderer() -> Self {
        vec!["electron-renderer".to_string()]
    }
    
    /// Web Worker
    pub fn web_worker() -> Self {
        vec!["webworker".to_string()]
    }
    
    /// ES5 兼容
    pub fn es5() -> Self {
        vec!["es5".to_string()]
    }
    
    /// ES2015+ 现代浏览器
    pub fn es2015() -> Self {
        vec!["es2015".to_string()]
    }
}
```

#### TargetProperties

```rust
/// 目标环境属性配置
#[derive(Debug, Clone, PartialEq, Eq)]
pub struct TargetProperties {
    /// 是否支持动态导入
    pub dynamic_import: Option<bool>,
    
    /// 是否支持 ES 模块
    pub es_modules: Option<bool>,
    
    /// 环境类型
    pub environment: Option<Environment>,
    
    /// 全局对象名称
    pub global_object: Option<String>,
    
    /// 是否支持 Node.js
    pub node: Option<bool>,
    
    /// 是否支持 Web
    pub web: Option<bool>,
}
```

### 开发工具配置

#### Devtool

```rust
/// 开发工具配置（Source Map）
#[derive(Debug, Clone, PartialEq, Eq)]
pub enum Devtool {
    /// 不生成 source map
    False,
    
    /// 生成独立的 source map 文件
    SourceMap,
    
    /// 内联 source map
    InlineSourceMap,
    
    /// 隐藏源码的 source map
    HiddenSourceMap,
    
    /// 外部 source map（不包含源码）
    NoSourcesSourceMap,
    
    /// 仅包含行信息的 source map
    CheapSourceMap,
    
    /// 包含模块信息的 cheap source map
    CheapModuleSourceMap,
    
    /// 用于开发的 eval
    Eval,
    
    /// eval + source map
    EvalSourceMap,
    
    /// eval + cheap source map
    EvalCheapSourceMap,
    
    /// eval + cheap module source map
    EvalCheapModuleSourceMap,
}

impl Devtool {
    /// 是否生成 source map
    pub fn generates_source_map(&self) -> bool;
    
    /// 是否内联 source map
    pub fn is_inline(&self) -> bool;
    
    /// 是否隐藏源码
    pub fn hides_sources(&self) -> bool;
    
    /// 是否使用 eval
    pub fn uses_eval(&self) -> bool;
}
```

### 条件编译的 Loader 支持

#### Loader 启用方法

```rust
impl CompilerBuilder {
    /// 启用 LightningCSS loader（需要 lightning-css 特性）
    #[cfg(feature = "lightning-css")]
    pub fn enable_loader_lightningcss(mut self) -> Self;
    
    /// 启用 SWC loader（需要 swc 特性）
    #[cfg(feature = "swc")]
    pub fn enable_loader_swc(mut self) -> Self;
    
    /// 启用 React 热刷新 loader（需要 react-refresh 特性）
    #[cfg(feature = "react-refresh")]
    pub fn enable_loader_react_refresh(mut self) -> Self;
    
    /// 启用 Preact 热刷新 loader（需要 preact-refresh 特性）
    #[cfg(feature = "preact-refresh")]
    pub fn enable_loader_preact_refresh(mut self) -> Self;
}
```

### 内置插件系统

#### BuilderContext

```rust
/// 构建器上下文 - 管理内置插件
pub struct BuilderContext {
    plugins: Vec<BoxPlugin>,
}

impl BuilderContext {
    /// 创建默认上下文
    pub fn default() -> Self;
    
    /// 添加插件
    pub fn plugin(&mut self, plugin: BoxPlugin);
    
    /// 获取所有插件
    pub fn take_plugins(self) -> Vec<BoxPlugin>;
}
```

内置插件包括（97种不同类型）：

**外部依赖处理插件**
- `ExternalsPlugin` - 外部依赖处理
- `NodeTargetPlugin` - Node.js 目标环境支持
- `ElectronTargetPlugin` - Electron 目标环境支持
- `HttpExternalsPlugin` - HTTP 外部依赖支持

**代码块格式和加载插件**
- `CommonJsChunkFormatPlugin` - CommonJS chunk 格式
- `ArrayPushCallbackChunkFormatPlugin` - 数组推送回调格式
- `ModuleChunkFormatPlugin` - ES 模块 chunk 格式
- `JsonpChunkLoadingPlugin` - JSONP chunk 加载
- `ImportScriptsChunkLoadingPlugin` - ImportScripts 加载
- `CommonJsChunkLoadingPlugin` - CommonJS chunk 加载
- `ModuleChunkLoadingPlugin` - ES 模块 chunk 加载

**开发工具插件**
- `SourceMapDevToolPlugin` - Source Map 生成
- `EvalSourceMapDevToolPlugin` - Eval Source Map
- `EvalDevToolModulePlugin` - Eval 开发工具

**核心模块插件**
- `JavascriptModulesPlugin` - JavaScript 模块支持
- `JsonModulesPlugin` - JSON 模块支持
- `AssetModulesPlugin` - 资源模块支持
- `CssModulesPlugin` - CSS 模块支持（实验性）

**入口和运行时插件**
- `EntryPlugin` - 入口处理
- `RuntimePlugin` - 运行时代码生成
- `RuntimeChunkPlugin` - 运行时 chunk 分离

### 使用示例

#### 基础使用

```rust
use rspack::*;

#[tokio::main]
async fn main() -> Result<()> {
    let mut compiler = Compiler::builder()
        .context("./src")
        .entry("main", "./index.js")
        .mode(Mode::Development)
        .output(
            OutputOptions::builder()
                .path("./dist".into())
                .filename(Filename::from("[name].js"))
                .build()
        )
        .build()?;
    
    compiler.build().await?;
    Ok(())
}
```

#### 高级配置

```rust
use rspack::*;

#[tokio::main]
async fn main() -> Result<()> {
    let mut compiler = Compiler::builder()
        .name("my-app")
        .context("./src")
        .entries([
            ("main".to_string(), "./index.js".to_string()),
            ("vendor".to_string(), "./vendor.js".to_string()),
        ])
        .target(Targets::web())
        .mode(Mode::Production)
        .output(
            OutputOptions::builder()
                .path("./dist".into())
                .filename(Filename::from("[name].[contenthash].js"))
                .chunk_filename(Filename::from("[name].[contenthash].chunk.js"))
                .public_path(PublicPath::from("/assets/"))
                .clean(true)
                .build()
        )
        .optimization(
            Optimization::builder()
                .minimize(true)
                .split_chunks(SplitChunksOptions::default())
                .runtime_chunk(RuntimeChunk::Single)
                .side_effects(SideEffects::False)
                .used_exports(UsedExports::True)
                .concatenate_modules(true)
                .build()
        )
        .devtool(Devtool::SourceMap)
        .experiments(
            Experiments::builder()
                .css(true)
                .future_defaults(true)
                .build()
        )
        .plugin(MyCustomPlugin::new())
        .build()?;
    
    compiler.build().await?;
    Ok(())
}
```

#### 带 Loader 的使用

```rust
use rspack::*;

#[tokio::main]
async fn main() -> Result<()> {
    let mut compiler = Compiler::builder()
        .context("./src")
        .entry("main", "./index.js")
        .mode(Mode::Development)
        .module(
            ModuleOptions::builder()
                .rules([
                    ModuleRule::builder()
                        .test(RuleSetCondition::Regexp(Regex::new(r"\.tsx?$").unwrap()))
                        .use_loader("swc-loader")
                        .build(),
                    ModuleRule::builder()
                        .test(RuleSetCondition::Regexp(Regex::new(r"\.css$").unwrap()))
                        .use_loaders(["style-loader", "css-loader"])
                        .build(),
                ])
                .build()
        )
        // 启用条件编译的 loader
        #[cfg(feature = "swc")]
        .enable_loader_swc()
        #[cfg(feature = "react-refresh")]
        .enable_loader_react_refresh()
        .build()?;
    
    compiler.build().await?;
    Ok(())
}
```

#### 监视模式

```rust
use rspack::*;

#[tokio::main]
async fn main() -> Result<()> {
    let mut compiler = Compiler::builder()
        .context("./src")
        .entry("main", "./index.js")
        .mode(Mode::Development)
        .watch(
            WatchOptions::builder()
                .aggregation_timeout(300)
                .poll(Some(1000))
                .ignored(vec!["**/node_modules/**".to_string()])
                .build()
        )
        .build()?;
    
    // 启动监视模式
    compiler.watch().await?;
    Ok(())
}
```

### Builder trait

```rust
/// 构建器 trait - 为各种配置提供统一的构建接口
pub trait Builder {
    type Item;
    
    /// 创建构建器
    fn builder() -> Self::Item;
}

// 为各种配置类型实现 Builder trait
impl Builder for OutputOptions {
    type Item = OutputOptionsBuilder;
    fn builder() -> Self::Item { OutputOptionsBuilder::default() }
}

impl Builder for ModuleOptions {
    type Item = ModuleOptionsBuilder;  
    fn builder() -> Self::Item { ModuleOptionsBuilder::default() }
}

impl Builder for Optimization {
    type Item = OptimizationOptionsBuilder;
    fn builder() -> Self::Item { OptimizationOptionsBuilder::default() }
}
```

### 特性和性能

#### 编译性能优化

- **增量编译**: 自动检测文件变化，只重新编译必要的模块
- **并行处理**: 利用多核心并行编译模块
- **智能缓存**: 多级缓存系统，提升重复构建速度
- **惰性加载**: 按需加载模块和依赖

#### 内存管理

- **零拷贝**: 尽可能避免不必要的数据复制
- **弱引用**: 防止循环引用导致的内存泄漏
- **资源池**: 复用昂贵的资源对象
- **及时清理**: 自动清理不再使用的临时数据

#### 错误处理

- **友好错误**: 提供详细的错误信息和建议
- **错误恢复**: 在可能的情况下继续编译
- **诊断信息**: 丰富的编译诊断和警告信息
- **源码映射**: 准确的错误位置定位

### 扩展指南

#### 自定义插件

```rust
use rspack::*;

#[derive(Debug)]
struct MyPlugin {
    name: String,
}

impl MyPlugin {
    pub fn new(name: String) -> Self {
        Self { name }
    }
}

impl Plugin for MyPlugin {
    fn name(&self) -> &'static str {
        "MyPlugin"
    }
    
    fn apply(&self, ctx: &mut ApplyContext) -> Result<()> {
        // 注册编译钩子
        ctx.compiler_hooks
            .compilation
            .tap(compilation_hook::new(self));
            
        // 注册编译过程钩子
        ctx.compilation_hooks
            .process_assets
            .tap(process_assets_hook::new(self));
            
        Ok(())
    }
}
```

#### 自定义 Loader

```rust
use rspack_loader_runner::*;

pub struct MyLoader;

impl Loader for MyLoader {
    fn name(&self) -> &'static str {
        "my-loader"
    }
    
    async fn run(&self, ctx: &mut LoaderContext<'_>) -> Result<()> {
        let content = ctx.content()?;
        
        // 处理内容
        let processed = process_content(content)?;
        
        // 设置处理后的内容
        ctx.set_content(processed);
        
        Ok(())
    }
}

fn process_content(content: &str) -> Result<String> {
    // 自定义处理逻辑
    Ok(content.replace("OLD", "NEW"))
}
```

这个构建器模块提供了强大而灵活的 API，让用户能够以声明式的方式配置复杂的构建流程，同时保持了 Rust 的类型安全和性能优势。