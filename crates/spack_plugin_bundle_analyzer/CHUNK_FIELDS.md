# Chunk ç»“æ„å­—æ®µæ‰©å±•åˆ†æ

æœ¬æ–‡æ¡£åˆ†æ Chunk æ•°æ®ç»“æ„çš„æ½œåœ¨å­—æ®µæ‰©å±•å»ºè®®ã€‚

## ä¼˜å…ˆçº§è¯´æ˜

- **é«˜ä¼˜å…ˆçº§ (High)**: æ˜¾è‘—æå‡åˆ†æèƒ½åŠ›ï¼Œå®ç°æˆæœ¬åˆç†
- **ä¸­ä¼˜å…ˆçº§ (Medium)**: æœ‰ä»·å€¼ä½†å®ç°æˆæœ¬è¾ƒé«˜ï¼Œæˆ–ä½¿ç”¨åœºæ™¯ç›¸å¯¹å—é™
- **ä½ä¼˜å…ˆçº§ (Low)**: ä»·å€¼è¾ƒå°æˆ–å®ç°æˆæœ¬è¿‡é«˜

---

## å½“å‰ Chunk ç»“æ„

```rust
pub struct Chunk {
  pub id: String,
  pub names: Vec<String>,
  pub size: u64,
  pub modules: Vec<String>,
  pub entry: bool,
  pub initial: bool,
  pub reason: String,
  pub files: Vec<String>,
  pub async_chunks: bool,
  pub runtime: bool,
}
```

---

## 1. parents: Vec<String> ğŸ”¶ ä¸­ä¼˜å…ˆçº§

### å®ç°å¤æ‚åº¦

- **å¤æ‚åº¦**: ä½åˆ°ä¸­ç­‰
- **å®ç°æ–¹å¼**: ä» rspack çš„ `ChunkGroup` ä¸­æå–çˆ¶ chunk å…³ç³»
- **ä»£ç é‡**: çº¦ 40-70 è¡Œ
- **å…³é”® API**: `chunk_group.parents` æˆ–é€šè¿‡ `chunk_graph` éå†

```rust
// ä¼ªä»£ç 
pub fn collect_parent_chunks(chunk: &Chunk, compilation: &Compilation) -> Vec<String> {
  let chunk_graph = &compilation.chunk_graph;
  chunk_graph.get_chunk_entry_dependent_chunks_iterable(&chunk.ukey)
    .map(|parent| parent.id.clone())
    .collect()
}
```

### å¢åŠ çš„æ•°æ®é‡

- **æ¯ä¸ª Chunk**: å–å†³äº chunk å±‚çº§ç»“æ„
  - å…¥å£ chunk: 0 ä¸ª parentsï¼Œ0 å­—èŠ‚
  - å¼‚æ­¥ chunk: 1-3 ä¸ª parentsï¼Œçº¦ 20-60 å­—èŠ‚
  - æ·±å±‚å¼‚æ­¥ chunk: å¯èƒ½æ›´å¤š
- **å…¸å‹é¡¹ç›®** (20 ä¸ª chunksï¼Œå¹³å‡ 1 ä¸ª parent): çº¦ 400 å­—èŠ‚
- **å¤§å‹é¡¹ç›®** (200 ä¸ª chunks): çº¦ 4KB
- **å¢é•¿ç‡**: å¯¹æ€»æ•°æ®é‡å½±å“ < 0.5%

### æ€§èƒ½å¼€é”€

- **é‡‡é›†é˜¶æ®µ**: ä½
  - rspack å†…éƒ¨å·²ç»´æŠ¤ chunk ä¾èµ–å…³ç³»
  - ä»…éœ€è¯»å–ç°æœ‰æ•°æ®ç»“æ„
  - æ—¶é—´å¤æ‚åº¦: O(n)ï¼Œn = chunk æ•°é‡
  - å…¸å‹å¼€é”€: < 5ms
- **å†…å­˜å¼€é”€**: ä½
- **ä¼ è¾“å¼€é”€**: å¯å¿½ç•¥

### å¯å®ç°åŠŸèƒ½åˆ—è¡¨

1. **Chunk ä¾èµ–å›¾**:
   - å¯è§†åŒ– chunk åŠ è½½é¡ºåº
   - å±•ç¤º chunk å±‚çº§å…³ç³»
2. **åŠ è½½é¡ºåºä¼˜åŒ–**:
   - è¯†åˆ«å…³é”® chunk è·¯å¾„
   - ä¼˜åŒ– preload/prefetch ç­–ç•¥
3. **Chunk æ‹†åˆ†åˆ†æ**:
   - è¯„ä¼°å½“å‰ chunk æ‹†åˆ†ç­–ç•¥
   - è¯†åˆ«ä¸åˆç†çš„ chunk ä¾èµ–
4. **æ€§èƒ½ç“¶é¢ˆè¯†åˆ«**:
   - æ‰¾å‡ºåŠ è½½é“¾è¿‡é•¿çš„ chunk
   - å»ºè®®åˆå¹¶æŸäº› parent-child chunk
5. **å¹¶è¡ŒåŠ è½½ä¼˜åŒ–**:
   - è¯†åˆ«å¯ä»¥å¹¶è¡ŒåŠ è½½çš„ chunk
   - ä¼˜åŒ– chunk ä¾èµ–ç»“æ„
6. **ä»£ç æ‹†åˆ†ç­–ç•¥**:
   - åŸºäºä¾èµ–å…³ç³»è°ƒæ•´æ‹†åˆ†ç²’åº¦
   - é¿å…è¿‡åº¦æ‹†åˆ†å¯¼è‡´çš„è¯·æ±‚æ•°æ¿€å¢

---

## 2. children: Vec<String> ğŸ”¶ ä¸­ä¼˜å…ˆçº§

### å®ç°å¤æ‚åº¦

- **å¤æ‚åº¦**: ä½åˆ°ä¸­ç­‰
- **å®ç°æ–¹å¼**: ä¸ parents åŒæ—¶ä» rspack æå–
- **ä»£ç é‡**: çº¦ 40-70 è¡Œï¼ˆé€šå¸¸ä¸ parents ä¸€èµ·å®ç°ï¼‰

```rust
// ä¼ªä»£ç 
pub fn collect_child_chunks(chunk: &Chunk, compilation: &Compilation) -> Vec<String> {
  let chunk_graph = &compilation.chunk_graph;
  chunk.get_all_async_chunks()
    .iter()
    .map(|child| child.id.clone())
    .collect()
}
```

### å¢åŠ çš„æ•°æ®é‡

- **æ¯ä¸ª Chunk**:
  - å¶å­ chunkï¼ˆæ— å¼‚æ­¥å¯¼å…¥ï¼‰: 0 ä¸ª childrenï¼Œ0 å­—èŠ‚
  - åŒ…å«å¼‚æ­¥å¯¼å…¥çš„ chunk: 1-10 ä¸ª childrenï¼Œçº¦ 20-200 å­—èŠ‚
  - è·¯ç”± chunkï¼ˆå¤§é‡æ‡’åŠ è½½ï¼‰: å¯èƒ½ 10+ ä¸ª children
- **å…¸å‹é¡¹ç›®** (20 ä¸ª chunksï¼Œå¹³å‡ 2 ä¸ª children): çº¦ 800 å­—èŠ‚
- **å¤§å‹é¡¹ç›®** (200 ä¸ª chunks): çº¦ 8KB
- **å¢é•¿ç‡**: å¯¹æ€»æ•°æ®é‡å½±å“ < 0.5%

### æ€§èƒ½å¼€é”€

- **é‡‡é›†é˜¶æ®µ**: ä½
  - ä¸ parents ä¸€èµ·æ”¶é›†ï¼Œå‡ ä¹æ— é¢å¤–å¼€é”€
  - æ—¶é—´å¤æ‚åº¦: O(n)
  - å…¸å‹å¼€é”€: < 5ms
- **å†…å­˜å¼€é”€**: ä½
- **ä¼ è¾“å¼€é”€**: å¯å¿½ç•¥

### å¯å®ç°åŠŸèƒ½åˆ—è¡¨

1. **å¼‚æ­¥åŠ è½½åˆ†æ**:
   - è¯†åˆ«æ‰€æœ‰å¼‚æ­¥å­æ¨¡å—
   - è¯„ä¼°ä»£ç æ‹†åˆ†æ•ˆæœ
2. **æ‡’åŠ è½½å¯è§†åŒ–**:
   - å±•ç¤ºåŠ¨æ€ import() äº§ç”Ÿçš„ chunk
   - è·¯ç”±æ‡’åŠ è½½å…³ç³»å›¾
3. **Bundle ä¼˜åŒ–å»ºè®®**:
   - è¯†åˆ«è¿‡åº¦æ‹†åˆ†çš„æƒ…å†µ
   - å»ºè®®åˆå¹¶å°å‹å¼‚æ­¥ chunk
4. **åŠ è½½æ€§èƒ½ä¼˜åŒ–**:
   - è¯„ä¼°å¼‚æ­¥ chunk çš„åŠ è½½æ—¶æœº
   - å»ºè®® prefetch ä¼˜å…ˆçº§
5. **ä»£ç æ‹†åˆ†æ•ˆæœè¯„ä¼°**:
   - ç»Ÿè®¡é¦–å± vs å¼‚æ­¥ä»£ç æ¯”ä¾‹
   - è¯„ä¼°æ‹†åˆ†ç²’åº¦æ˜¯å¦åˆç†
6. **è·¯ç”±çº§åˆ«åˆ†æ**:
   - è¯†åˆ«æ¯ä¸ªè·¯ç”±å¯¹åº”çš„ chunk æ ‘
   - ä¼˜åŒ–è·¯ç”±çº§åˆ«çš„ä»£ç æ‹†åˆ†

---

## æ€»ç»“

### å»ºè®®å®æ–½é¡ºåº

**parents + children** (ä¸­ä¼˜å…ˆçº§)
- å»ºè®®ä¸€èµ·å®ç°ï¼Œå®Œå–„æ•´ä½“ä¾èµ–åˆ†æå›¾æ™¯
- å®ç°æˆæœ¬ä½ï¼Œæ•°æ®å¢é•¿å°
- å»ºè®®åœ¨ç¬¬äºŒé˜¶æ®µå®ç°

### æ€§èƒ½å¯¹æ¯”

| å­—æ®µ     | é‡‡é›†å¼€é”€ | æ•°æ®å¢é•¿ | ä¼ è¾“å½±å“ |
| -------- | -------- | -------- | -------- |
| parents  | < 5ms    | < 0.5%   | ä½       |
| children | < 5ms    | < 0.5%   | ä½       |

### é‡è¦æç¤º

Chunk çš„ parents å’Œ children å­—æ®µæä¾›äº† chunk çº§åˆ«çš„ä¾èµ–å…³ç³»è§†å›¾ï¼Œä¸ Module çš„ä¾èµ–å…³ç³»äº’è¡¥ã€‚å»ºè®®åœ¨å®ç° Module ä¾èµ–å…³ç³»åä½œä¸ºè¡¥å……åŠŸèƒ½å®ç°ã€‚
