# Package ç»“æ„å­—æ®µæ‰©å±•åˆ†æ

æœ¬æ–‡æ¡£åˆ†æ Package æ•°æ®ç»“æ„çš„æ½œåœ¨å­—æ®µæ‰©å±•å»ºè®®ã€‚

## ä¼˜å…ˆçº§è¯´æ˜

- **é«˜ä¼˜å…ˆçº§ (High)**: æ˜¾è‘—æå‡åˆ†æèƒ½åŠ›ï¼Œå®ç°æˆæœ¬åˆç†
- **ä¸­ä¼˜å…ˆçº§ (Medium)**: æœ‰ä»·å€¼ä½†å®ç°æˆæœ¬è¾ƒé«˜ï¼Œæˆ–ä½¿ç”¨åœºæ™¯ç›¸å¯¹å—é™
- **ä½ä¼˜å…ˆçº§ (Low)**: ä»·å€¼è¾ƒå°æˆ–å®ç°æˆæœ¬è¿‡é«˜

---

## å½“å‰ Package ç»“æ„

```rust
pub struct Package {
  pub name: String,
  pub version: String,
  pub size: u64,
  pub module_count: usize,
  pub modules: Vec<String>,
  pub package_json_path: String,
}
```

---

## 1. chunks: Vec<String> â­ é«˜ä¼˜å…ˆçº§

### å®ç°å¤æ‚åº¦

- **å¤æ‚åº¦**: ä½
- **å®ç°æ–¹å¼**: åœ¨æ”¶é›† modules æ—¶è®°å½•æ¯ä¸ª package å‡ºç°åœ¨å“ªäº› chunks ä¸­
- **ä»£ç é‡**: çº¦ 30-50 è¡Œï¼ˆä¿®æ”¹ç°æœ‰ Package æ”¶é›†é€»è¾‘ï¼‰

```rust
// ä¼ªä»£ç 
impl Packages {
  pub fn from_with_resolver(modules: &Modules, resolver: &mut Resolver) -> Self {
    let mut package_map: HashMap<String, PackageData> = HashMap::new();

    for module in modules {
      if let Some(pkg) = extract_package_name(&module.name) {
        let entry = package_map.entry(pkg).or_default();
        entry.modules.push(module.id.clone());
        // æ–°å¢ï¼šè®°å½• chunks
        entry.chunks.extend(module.chunks.clone());
      }
    }

    // å»é‡ chunks
    for (_, data) in &mut package_map {
      data.chunks.sort();
      data.chunks.dedup();
    }

    // ...
  }
}
```

### å¢åŠ çš„æ•°æ®é‡

- **æ¯ä¸ª Package**: å–å†³äºåŒ…çš„åˆ†å¸ƒ
  - å• chunk åŒ…ï¼ˆç†æƒ³æƒ…å†µï¼‰: 1 ä¸ª chunk IDï¼Œçº¦ 20 å­—èŠ‚
  - è·¨ chunk åŒ…: 2-5 ä¸ª chunk IDsï¼Œçº¦ 40-100 å­—èŠ‚
  - å¹¿æ³›ä½¿ç”¨çš„åŒ…ï¼ˆå¦‚ lodashï¼‰: å¯èƒ½ 10+ chunks
- **å…¸å‹é¡¹ç›®** (100 ä¸ª packagesï¼Œå¹³å‡ 1.5 ä¸ª chunks): çº¦ 3KB
- **å¤§å‹é¡¹ç›®** (500 ä¸ª packages): çº¦ 15KB
- **å¢é•¿ç‡**: å¯¹æ€»æ•°æ®é‡å½±å“ < 2%

### æ€§èƒ½å¼€é”€

- **é‡‡é›†é˜¶æ®µ**: å‡ ä¹ä¸ºé›¶
  - ä»…åœ¨ç°æœ‰çš„æ¨¡å—éå†ä¸­æ·»åŠ è®°å½•
  - é¢å¤–æ“ä½œ: å»é‡æ’åºï¼ˆO(k log k)ï¼Œk = chunk æ•°é‡ï¼Œé€šå¸¸ < 10ï¼‰
  - å…¸å‹å¼€é”€: < 5ms
- **å†…å­˜å¼€é”€**: ä½
- **ä¼ è¾“å¼€é”€**: ä½

### å¯å®ç°åŠŸèƒ½åˆ—è¡¨

1. **ä»£ç é‡å¤æ£€æµ‹**: â­ æ ¸å¿ƒåŠŸèƒ½
   - è¯†åˆ«åœ¨å¤šä¸ª chunk ä¸­é‡å¤æ‰“åŒ…çš„åŒ…
   - è®¡ç®—é‡å¤ä»£ç é€ æˆçš„é¢å¤–ä½“ç§¯
2. **Vendor Chunk ä¼˜åŒ–**:
   - åˆ†æå“ªäº›åŒ…åº”è¯¥æå–åˆ°å…±äº« vendor chunk
   - å»ºè®® splitChunks é…ç½®
3. **åŒ…åˆ†å¸ƒå¯è§†åŒ–**:
   - å±•ç¤ºæ¯ä¸ªåŒ…åœ¨å“ªäº› chunk ä¸­å‡ºç°
   - çƒ­åŠ›å›¾æ˜¾ç¤ºåŒ…çš„å…±äº«ç¨‹åº¦
4. **ä»£ç å…±äº«ä¼˜åŒ–**:
   - è¯†åˆ«å¯ä»¥è¿›ä¸€æ­¥å…±äº«çš„åŒ…
   - ä¼˜åŒ– chunk æ‹†åˆ†ç­–ç•¥å‡å°‘é‡å¤
5. **ä½“ç§¯å½’å› åˆ†æ**:
   - æŒ‰ chunk è¿½æº¯åŒ…çš„ä½“ç§¯å æ¯”
   - è¯†åˆ«å¯¼è‡´æŸä¸ª chunk è¿‡å¤§çš„åŒ…
6. **æ„å»ºé…ç½®å»ºè®®**:
   - åŸºäºåŒ…åˆ†å¸ƒè‡ªåŠ¨ç”Ÿæˆ splitChunks é…ç½®
   - ä¼˜åŒ– cacheGroups è®¾ç½®
7. **ä¾èµ–ç‰ˆæœ¬ä¸€è‡´æ€§**:
   - ç»“åˆ chunk åˆ†å¸ƒæ£€æŸ¥åŒä¸€åŒ…çš„ä¸åŒç‰ˆæœ¬
   - è¯†åˆ«å¯èƒ½çš„é‡å¤ä¾èµ–é—®é¢˜

---

## 2. license: String ğŸ”· ä½ä¼˜å…ˆçº§

### å®ç°å¤æ‚åº¦

- **å¤æ‚åº¦**: ä¸­ç­‰
- **å®ç°æ–¹å¼**: è¯»å–å¹¶è§£æ package.json çš„ license å­—æ®µ
- **ä»£ç é‡**: çº¦ 60-100 è¡Œ
- **æŒ‘æˆ˜**:
  - éœ€è¦è®¿é—®æ–‡ä»¶ç³»ç»Ÿè¯»å– package.json
  - license å­—æ®µæ ¼å¼ä¸ç»Ÿä¸€ï¼ˆå­—ç¬¦ä¸² / å¯¹è±¡ / æ•°ç»„ï¼‰
  - éœ€è¦ç¼“å­˜é¿å…é‡å¤è¯»å–

```rust
// ä¼ªä»£ç 
async fn extract_license(package_json_path: &str) -> Option<String> {
  let content = fs::read_to_string(package_json_path).await.ok()?;
  let json: serde_json::Value = serde_json::from_str(&content).ok()?;

  // å¤„ç†å¤šç§ license æ ¼å¼
  match &json["license"] {
    serde_json::Value::String(s) => Some(s.clone()),
    serde_json::Value::Object(obj) => obj.get("type").and_then(|v| v.as_str()).map(String::from),
    _ => None,
  }
}
```

### å¢åŠ çš„æ•°æ®é‡

- **æ¯ä¸ª Package**: çº¦ 5-30 å­—èŠ‚ï¼ˆlicense å­—ç¬¦ä¸²ï¼‰
  - å¸¸è§ license: "MIT" (3), "Apache-2.0" (10), "BSD-3-Clause" (13)
- **å…¸å‹é¡¹ç›®** (100 ä¸ª packages): çº¦ 1-2KB
- **å¤§å‹é¡¹ç›®** (500 ä¸ª packages): çº¦ 5-10KB
- **å¢é•¿ç‡**: å¯¹æ€»æ•°æ®é‡å½±å“ < 1%

### æ€§èƒ½å¼€é”€

- **é‡‡é›†é˜¶æ®µ**: ä¸­ç­‰
  - éœ€è¦è¯»å–æ¯ä¸ªåŒ…çš„ package.json æ–‡ä»¶
  - å¦‚æœå·²åœ¨å†…å­˜ä¸­ï¼ˆpackage version è§£ææ—¶è¯»å–ï¼‰: ä½å¼€é”€
  - å¦‚æœéœ€è¦é¢å¤–è¯»å–: æ¯ä¸ªæ–‡ä»¶çº¦ 1-5ms
  - å…¸å‹é¡¹ç›®: çº¦ 100-500ms
  - å¤§å‹é¡¹ç›®: çº¦ 500ms - 2s
- **ä¼˜åŒ–æ–¹æ¡ˆ**:
  - ä¸ package version è§£æå…±äº«æ–‡ä»¶è¯»å–
  - æ·»åŠ é…ç½®å¼€å…³ï¼ˆé»˜è®¤å…³é—­ï¼‰
- **å†…å­˜å¼€é”€**: ä½
- **ä¼ è¾“å¼€é”€**: å¯å¿½ç•¥

### å¯å®ç°åŠŸèƒ½åˆ—è¡¨

1. **è®¸å¯è¯æŠ¥å‘Šç”Ÿæˆ**:
   - è‡ªåŠ¨ç”Ÿæˆé¡¹ç›®çš„å¼€æºè®¸å¯è¯æ¸…å•
   - å¯¼å‡ºä¸ºå¤šç§æ ¼å¼ï¼ˆJSON/Markdown/HTMLï¼‰
2. **è®¸å¯è¯åˆè§„æ£€æŸ¥**:
   - è¯†åˆ«ä¸å…¼å®¹çš„è®¸å¯è¯ç»„åˆ
   - æ£€æµ‹å•†ä¸šä½¿ç”¨é™åˆ¶çš„è®¸å¯è¯
3. **è®¸å¯è¯é£é™©è¯„ä¼°**:
   - æ ‡è®°é«˜é£é™©è®¸å¯è¯ï¼ˆå¦‚ GPL/AGPLï¼‰
   - è¯†åˆ«æ— è®¸å¯è¯çš„åŒ…
4. **æ³•å¾‹å®¡è®¡æ”¯æŒ**:
   - ä¼ä¸šåˆè§„æ€§æ£€æŸ¥
   - å¼€æºå®¡è®¡æŠ¥å‘Š
5. **è®¸å¯è¯ç»Ÿè®¡**:
   - æŒ‰è®¸å¯è¯ç±»å‹ç»Ÿè®¡åŒ…æ•°é‡
   - å¯è§†åŒ–è®¸å¯è¯åˆ†å¸ƒ
6. **ä¾èµ–é€‰æ‹©å»ºè®®**:
   - åŸºäºè®¸å¯è¯æ¨èæ›¿ä»£åŒ…
   - é¿å…ä½¿ç”¨å—é™è®¸å¯è¯çš„åŒ…

---

## æ€»ç»“

### å»ºè®®å®æ–½é¡ºåº

1. **chunks** (é«˜ä¼˜å…ˆçº§)
   - å®ç°æˆæœ¬ä½ï¼Œç«‹å³è§£å†³ä»£ç é‡å¤é—®é¢˜
   - å»ºè®®åœ¨ç¬¬ä¸€é˜¶æ®µä¼˜å…ˆå®æ–½

2. **license** (ä½ä¼˜å…ˆçº§)
   - é€‚åˆä¼ä¸šåˆè§„æ€§è¦æ±‚é«˜çš„é¡¹ç›®
   - ä½œä¸ºå¯é€‰åŠŸèƒ½ï¼Œé»˜è®¤å…³é—­

### æ€§èƒ½å¯¹æ¯”

| å­—æ®µ    | é‡‡é›†å¼€é”€    | æ•°æ®å¢é•¿ | ä¼ è¾“å½±å“ |
| ------- | ----------- | -------- | -------- |
| chunks  | < 5ms       | < 2%     | ä½       |
| license | 100ms - 2s  | < 1%     | ä½       |

### é‡è¦æç¤º

**chunks** å­—æ®µæ˜¯ Package ç»“æ„æœ€é‡è¦çš„æ‰©å±•ï¼Œèƒ½å¤Ÿç›´æ¥è¯†åˆ«ä»£ç é‡å¤é—®é¢˜ï¼Œè¿™æ˜¯ bundle ä¼˜åŒ–çš„å…³é”®æŒ‡æ ‡ã€‚å¼ºçƒˆå»ºè®®ä¼˜å…ˆå®ç°ã€‚
